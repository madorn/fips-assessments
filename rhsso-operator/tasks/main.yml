---
- name: Create keycloak CR in target_namespace
  kubernetes.core.k8s:
    state: present
    namespace: "{{ target_namespace }}"
    definition:
      apiVersion: keycloak.org/v1alpha1
      kind: Keycloak
      metadata:
        name: example-keycloak
        labels:
          app: sso
      spec:
        instances: 1
        externalAccess:
          enabled: true
- name: Wait for define
  kubernetes.core.k8s_info:
    api_version: keycloak.org/v1alpha1
    kind: Keycloak
    name: example-keycloak
    namespace: "{{ target_namespace }}"
  register: result
  until: result.resources[0].status.ready is defined
  retries: 10
  delay: 10
  failed_when: result.resources[0] is not defined
- name: Wait for ready
  kubernetes.core.k8s_info:
    api_version: keycloak.org/v1alpha1
    kind: Keycloak
    name: example-keycloak
    namespace: "{{ target_namespace }}"
  register: result
  until: result.resources[0].status.ready == "true"
  retries: 10
  delay: 10
  failed_when: result.resources[0] is not defined
- name: Clean up operand
  kubernetes.core.k8s:
    state: absent
    api_version: keycloak.org/v1alpha1
    kind: Keycloak
    name: example-keycloak
    namespace: "{{ target_namespace }}"
    wait: true
    wait_timeout: 60
    wait_sleep: 5
